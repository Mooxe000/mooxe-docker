version: '3'

includes:
  apt: ./apt.yml

vars:
  # git_host: github.com
  git_host: download.fastgit.org

  # dl_bin: wget
  # dl_cmd: '{{dl_bin}} -o-'
  dl_bin: curl
  dl_cmd: '{{.dl_bin}} -O'

tasks:

  default:
    cmds:
      - echo 'Hello World from Task!'
    silent: true

  install-fswatch-before:
    cmds:
      - apt install -y make
        g++ g++-11 gcc gcc-11 gcc-11-base
        gcc-multilib gcc-11-multilib
        g++-multilib g++-11-multilib

  # https://github.com/emcrisostomo/fswatch/releases
  install-fswatch:
    deps:
      - install-fswatch-before
    vars:
      bin_name: fswatch
      git_proj: emcrisostomo/{{.bin_name}}
      bin_version: 1.17.1
      source_dir: '{{.bin_name}}-{{.bin_version}}'
      file_name: '{{.source_dir}}.tar.gz'
      url_prefix: https://{{.git_host}}/{{.git_proj}}/releases/download
      url: '{{.url_prefix}}/{{.bin_version}}/{{.file_name}}'
      dist_dir: /opt/{{.bin_name}}
    cmds:
      - '{{.dl_cmd}} {{.url}}'
      - tar xvf {{.file_name}}
      - mkdir -p {{.dist_dir}}
      - cd {{.source_dir}}
        ; ./configure --prefix={{.dist_dir}}
        ; make
        ; make install
      - ln -s {{.dist_dir}}/bin/fswatch /usr/local/bin/{{.bin_name}}
      - rm -rf {{.file_name}}
      - rm -rf {{.source_dir}}

  install-kawipiko:
    vars:
      bin_rename: kawipiko
      bin_name: '{{.bin_rename}}-wrapper'
      git_proj: volution/{{.bin_rename}}
      bin_version: v0.1.0
      bin_os: linux--x86_64
      file_name: '{{.bin_name}}--{{.bin_os}}--{{.bin_version}}--preview'
      url_prefix: https://{{.git_host}}/{{.git_proj}}/releases/download/preview
      url: '{{.url_prefix}}/{{.file_name}}'
    cmds:
      - '{{.dl_cmd}} {{.url}}'
      - mv {{.file_name}} {{.bin_rename}}
      - chmod +x {{.bin_rename}}
      - mv {{.bin_rename}} /usr/local/bin

  # https://github.com/joseluisq/static-web-server/releases
  install-sws:
    vars:
      bin_name: static-web-server
      bin_rename: sws
      git_proj: joseluisq/{{.bin_name}}
      bin_version: v2.12.0
      bin_os: x86_64-unknown-linux-gnu
      file_dir: '{{.bin_name}}-{{.bin_version}}-{{.bin_os}}'
      file_name: '{{.file_dir}}.tar.gz'
      url_prefix: https://{{.git_host}}/{{.git_proj}}/releases/download
      url: '{{.url_prefix}}/{{.bin_version}}/{{.file_name}}'
    cmds:
      - '{{.dl_cmd}} {{.url}}'
      - tar xvf {{.file_name}}
      - chmod +x ./{{.file_dir}}/{{.bin_name}}
      - cp ./{{.file_dir}}/{{.bin_name}} /usr/local/bin
      - ln -s /usr/local/bin/{{.bin_name}} /usr/local/bin/{{.bin_rename}}
      - rm -rf ./{{.file_dir}}*

  # https://download.fastgit.org/Nukesor/pueue/releases
  install-pueued-base:
    # https://download.fastgit.org/Nukesor/pueue/releases/download/v2.1.0/pueued-linux-x86_64
    # https://download.fastgit.org/Nukesor/pueue/releases/download/v2.1.0/pueue-linux-x86_64
    vars:
      # bin_name: pueued
      git_proj: Nukesor/pueue
      bin_version: v2.1.0
      bin_os: linux-x86_64
      url_prefix: https://{{.git_host}}/{{.git_proj}}/releases/download
      file_name: '{{.bin_name}}-{{.bin_os}}'
      url: '{{.url_prefix}}/{{.bin_version}}/{{.file_name}}'
    cmds:
      - '{{.dl_cmd}} {{.url}}'
      - chmod +x {{.file_name}}
      - mv {{.file_name}} /usr/local/bin/{{.bin_name}}

  install-pueued:
    cmds:
      - task: install-pueued-base
        vars:
          bin_name: pueued
      - task: install-pueued-base
        vars:
          bin_name: pueue
